<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Faktury – 3tla.local</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f9f9f9;
    }
    .hidden { display: none; }
    input, textarea, select, button {
      display: block;
      width: 100%;
      margin: 0.8rem 0;
      padding: 0.7rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0055aa; }
    button.logout {
      background: #c00;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.6rem;
      text-align: left;
    }
    th { background: #f0f0f0; }
    .document-item {
      border: 1px solid #ddd;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .error { color: #c00; min-height: 1.2rem; }
    nav {
      margin: 1.5rem 0;
      padding: 0.8rem;
      background: #f0f0f0;
      border-radius: 8px;
    }
    nav a {
      margin-right: 1.5rem;
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }
    nav a:hover { text-decoration: underline; }
    .no-access {
      text-align: center;
      padding: 3rem 1rem;
      color: #555;
    }
    #create-buttons button {
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
  </style>

  <!-- jsPDF dla PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, runTransaction, Timestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACzVKOmFK87VJJvBGCW921yrxbpKgYEKU",
      authDomain: "iiitla-zadania.firebaseapp.com",
      projectId: "iiitla-zadania",
      storageBucket: "iiitla-zadania.firebasestorage.app",
      messagingSenderId: "753248383455",
      appId: "1:753248383455:web:f39ab717514c979913146a",
      measurementId: "G-9DQCJ8T5QQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMIN_EMAIL = "mbecela@3tla.local";

    // ──── Helpers ────────────────────────────────────────
    const $ = id => document.getElementById(id);
    const show = el => el?.classList.remove("hidden");
    const hide = el => el?.classList.add("hidden");

    let currentUserEmail = '';
    let counterCache = {}; // Cache dla numerów bieżących

    // ──── Ładowanie listy faktur ─────────────────────────
    async function loadDocuments() {
      const container = $("documents-list");
      container.innerHTML = "<p>Ładowanie faktur...</p>";

      try {
        const q = query(collection(db, "documents"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);

        container.innerHTML = "";

        if (querySnapshot.empty) {
          container.innerHTML = "<p>Nie ma jeszcze żadnych faktur.</p>";
          return;
        }

        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const date = data.createdAt.toDate().toLocaleString("pl-PL");
          const div = document.createElement("div");
          div.className = "document-item";
          div.innerHTML = `
            <span><strong>Faktura nr ${data.number}</strong> (${data.createdBy}, ${date})</span>
          `;
          const downloadBtn = document.createElement("button");
          downloadBtn.textContent = "Pobierz PDF";
          downloadBtn.onclick = () => generatePDFFromData(data);
          div.appendChild(downloadBtn);
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = `<p class="error">Nie udało się wczytać faktur: ${err.message}</p>`;
      }
    }

    // ──── Generowanie PDF ────────────────────────────────
    function generatePDFFromData(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();

      // Ustawienie czcionki z polskim wsparciem (helvetica ma podstawowe diakrytyki, ale dla pewności używamy 'times' – lepsze dla PL)
      doc.setFont("times", "normal");

      let y = 10;

      doc.setFontSize(22);
      doc.setFont("times", "bold");
      doc.text("FAKTURA SPRZEDAŻY", 105, y, { align: "center" });
      y += 15;

      doc.setFontSize(12);
      doc.setFont("times", "normal");

      doc.text(`Numer faktury: ${data.number}`, 10, y);
      y += 10;
      doc.text(`Miejscowość: ${data.miejscowosc || ''}, Data sprzedaży: ${data.dataSprzedazy || ''}, Data wystawienia: ${data.dataWystawienia || ''}`, 10, y);
      y += 10;
      doc.text(`Sprzedawca: 3TLa`, 10, y);
      y += 10;
      doc.text(`Nabywca: ${data.nabywca.firma || ''}, ${data.nabywca.adres || ''}, NIP: ${data.nabywca.nip || ''}`, 10, y);
      y += 15;

      // Tabela
      const tableColumns = ["Lp.", "Nazwa wyrobu", "Ilość", "J.m.", "Cena netto", "Wartość netto", "VAT %", "Kwota VAT", "Wartość brutto"];
      const tableRows = data.items.map((item, index) => [
        index + 1,
        item.nazwa,
        item.ilosc,
        item.jm,
        item.cenaNetto,
        item.wartoscNetto,
        item.vat,
        item.kwotaVat,
        item.wartoscBrutto
      ]);

      doc.autoTable({
        startY: y,
        head: [tableColumns],
        body: tableRows,
        theme: 'grid',
        styles: { font: "times", fontSize: 10, cellPadding: 3, overflow: 'linebreak' },
        headStyles: { fillColor: [66, 139, 202] },
        columnStyles: { 0: { cellWidth: 10 }, 1: { cellWidth: 'auto' } } // automatyczne szerokości
      });

      y = doc.lastAutoTable.finalY + 15;

      doc.text(`Razem netto: ${data.summary.netto || ''}, VAT: ${data.summary.vat || ''}, Brutto: ${data.summary.brutto || ''}`, 10, y);
      y += 10;
      doc.text(`Sposób zapłaty: ${data.zaplata.sposob || ''}, Termin: ${data.zaplata.termin || ''}, Konto: ${data.zaplata.konto || ''}`, 10, y);
      y += 10;
      doc.text(`Do zapłaty słownie: ${data.zaplata.slownie || ''}`, 10, y);
      y += 15;

      doc.setFont("times", "bold");
      doc.text(`Podpis wystawcy: ${data.createdBy}`, 150, y, { align: "right" });

      doc.save(`Faktura_${data.number}.pdf`);
    }

    // ──── Pobieranie numeru bieżącego ────────────────────
    async function getNextNumber(type) {
      if (counterCache[type]) return counterCache[type] + 1;

      const counterRef = doc(db, "counters", type);
      return await runTransaction(db, async (transaction) => {
        const counterSnap = await transaction.get(counterRef);
        const current = counterSnap.exists() ? counterSnap.data().value : 0;
        const next = current + 1;
        transaction.set(counterRef, { value: next });
        counterCache[type] = next;
        return next;
      });
    }

    // ──── Tworzenie faktury ──────────────────────────────
    function showForm() {
      show($("form-section"));
      const table = $("items-table");
      table.innerHTML = '';

      const headers = ["Lp.", "Nazwa wyrobu", "Ilość", "J.m.", "Cena netto", "Wartość netto", "VAT %", "Kwota VAT", "Wartość brutto"];

      const thead = document.createElement("thead");
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        tr.appendChild(th);
      });
      const thAction = document.createElement("th");
      thAction.textContent = "Akcje";
      tr.appendChild(thAction);
      thead.appendChild(tr);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      table.appendChild(tbody);

      addRow();
    }

    // ──── Dodawanie wiersza do tabeli ────────────────────
    function addRow() {
      const tbody = $("items-table").querySelector("tbody");
      const lp = tbody.children.length + 1;
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${lp}</td>
        <td><input type="text" class="nazwa" placeholder="Nazwa wyrobu"></td>
        <td><input type="number" class="ilosc" min="1" value="1"></td>
        <td><input type="text" class="jm" placeholder="J.m."></td>
        <td><input type="number" class="cena-netto" min="0" step="0.01"></td>
        <td><input type="number" class="wartosc-netto" readonly></td>
        <td>
          <select class="vat">
            <option value="23">23%</option>
            <option value="8">8%</option>
            <option value="5">5%</option>
            <option value="0">0%</option>
          </select>
        </td>
        <td><input type="number" class="kwota-vat" readonly></td>
        <td><input type="number" class="wartosc-brutto" readonly></td>
      `;

      const tdAction = document.createElement("td");
      const btnRemove = document.createElement("button");
      btnRemove.textContent = "Usuń wiersz";
      btnRemove.style.background = "#c00";
      btnRemove.style.width = "auto";
      btnRemove.onclick = () => row.remove();
      tdAction.appendChild(btnRemove);
      row.appendChild(tdAction);

      tbody.appendChild(row);

      row.querySelectorAll('input.ilosc, input.cena-netto, select.vat').forEach(input => {
        input.addEventListener("input", () => calculateRow(row));
      });
    }

    // ──── Obliczanie wiersza ─────────────────────────────
    function calculateRow(row) {
      const ilosc = parseFloat(row.querySelector(".ilosc").value) || 0;
      const cenaNetto = parseFloat(row.querySelector(".cena-netto").value) || 0;
      const vat = parseFloat(row.querySelector(".vat").value) / 100;

      const wartoscNetto = ilosc * cenaNetto;
      const kwotaVat = wartoscNetto * vat;
      const wartoscBrutto = wartoscNetto + kwotaVat;

      row.querySelector(".wartosc-netto").value = wartoscNetto.toFixed(2);
      row.querySelector(".kwota-vat").value = kwotaVat.toFixed(2);
      row.querySelector(".wartosc-brutto").value = wartoscBrutto.toFixed(2);
    }

    // ──── Zapisywanie faktury ────────────────────────────
    async function saveDocument() {
      const errorEl = $("save-error");
      errorEl.textContent = "";

      const type = "Faktura";
      const number = await getNextNumber(type);
      const date = new Date().toLocaleString("pl-PL");
      const items = [];

      $("items-table").querySelectorAll("tbody tr").forEach(row => {
        const item = {
          nazwa: row.querySelector(".nazwa").value,
          ilosc: row.querySelector(".ilosc").value,
          jm: row.querySelector(".jm").value,
          cenaNetto: row.querySelector(".cena-netto").value,
          wartoscNetto: row.querySelector(".wartosc-netto").value,
          vat: row.querySelector(".vat").value,
          kwotaVat: row.querySelector(".kwota-vat").value,
          wartoscBrutto: row.querySelector(".wartosc-brutto").value
        };
        items.push(item);
      });

      if (items.length === 0) {
        errorEl.textContent = "Dodaj co najmniej jeden wiersz do tabeli";
        return;
      }

      const data = {
        type,
        number,
        date,
        createdBy: currentUserEmail,
        createdAt: Timestamp.now(),
        items,
        miejscowosc: $("miejscowosc").value,
        dataSprzedazy: $("data-sprzedazy").value,
        dataWystawienia: $("data-wystawienia").value,
        nabywca: {
          firma: $("nabywca-firma").value,
          adres: $("nabywca-adres").value,
          nip: $("nabywca-nip").value
        },
        summary: {
          netto: Array.from($("items-table").querySelectorAll(".wartosc-netto")).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2),
          vat: Array.from($("items-table").querySelectorAll(".kwota-vat")).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2),
          brutto: Array.from($("items-table").querySelectorAll(".wartosc-brutto")).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2)
        },
        zaplata: {
          sposob: $("sposob-zaplaty").value,
          termin: $("termin-zaplaty").value,
          konto: $("numer-konta").value,
          slownie: $("slownie").value
        }
      };

      try {
        await addDoc(collection(db, "documents"), data);
        alert("Faktura zapisana i wygenerowana!");
        generatePDFFromData(data); // Automatyczne pobranie PDF
        hide($("form-section"));
        loadDocuments();
      } catch (err) {
        errorEl.textContent = "Błąd zapisu: " + err.message;
      }
    }

    // ──── Nasłuch stanu ──────────────────────────────────
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      hide($("loading"));
      show($("content"));
      currentUserEmail = user.email;
      $("current-user").textContent = user.email;
      loadDocuments();
    });

    // ──── Eventy ─────────────────────────────────────────
    document.addEventListener("DOMContentLoaded", () => {
      $("btn-logout")?.addEventListener("click", () => signOut(auth));
      $("btn-save-doc")?.addEventListener("click", saveDocument);
      $("btn-add-row")?.addEventListener("click", () => addRow());

      // Automatycznie pokazujemy formularz faktury (jedyna opcja)
      showForm();
    });
  </script>
</head>
<body>

  <div id="loading">
    <h2>Ładowanie...</h2>
  </div>

  <div id="content" class="hidden">
    <nav>
      <a href="index.html">← Strona główna / Zadania</a>
      <a href="oceny.html">Oceny (admin)</a>
      <a href="produkcja.html">Produkcja</a>
    </nav>

    <h1>Panel Faktur</h1>
    <p>Zalogowany jako: <strong id="current-user"></strong></p>
    <button id="btn-logout" class="logout">Wyloguj się</button>

    <div id="form-section">
      <h2>Tworzenie faktury</h2>

      <input id="miejscowosc" placeholder="Miejscowość">
      <input id="data-sprzedazy" type="date" placeholder="Data sprzedaży">
      <input id="data-wystawienia" type="date" placeholder="Data wystawienia">
      <h3>Nabywca</h3>
      <input id="nabywca-firma" placeholder="Firma nabywcy">
      <input id="nabywca-adres" placeholder="Adres">
      <input id="nabywca-nip" placeholder="NIP">
      <h3>Zapłata</h3>
      <input id="sposob-zaplaty" placeholder="Sposób zapłaty">
      <input id="termin-zaplaty" type="date" placeholder="Termin zapłaty">
      <input id="numer-konta" placeholder="Numer konta">
      <input id="slownie" placeholder="Do zapłaty słownie">

      <h3>Tabela pozycji</h3>
      <table id="items-table"></table>
      <button id="btn-add-row">Dodaj wiersz</button>

      <button id="btn-save-doc">Zapisz i pobierz PDF</button>
      <div id="save-error" class="error"></div>
    </div>

    <h2>Lista utworzonych faktur</h2>
    <div id="documents-list"></div>
  </div>

</body>
</html>
