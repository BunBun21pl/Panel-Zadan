<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Dokumenty – 3tla.local</title>
  <style>
    body {
      font-family: system-ui, sans-serif;
      max-width: 1200px;
      margin: 2rem auto;
      padding: 0 1rem;
      background: #f9f9f9;
    }
    .hidden { display: none; }
    input, textarea, select, button {
      display: block;
      width: 100%;
      margin: 0.8rem 0;
      padding: 0.7rem;
      box-sizing: border-box;
      font-size: 1rem;
    }
    button {
      background: #0066cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    button:hover { background: #0055aa; }
    button.logout {
      background: #c00;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ddd;
      padding: 0.6rem;
      text-align: left;
    }
    th { background: #f0f0f0; }
    .document-item {
      border: 1px solid #ddd;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      background: white;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .error { color: #c00; min-height: 1.2rem; }
    nav {
      margin: 1.5rem 0;
      padding: 0.8rem;
      background: #f0f0f0;
      border-radius: 8px;
    }
    nav a {
      margin-right: 1.5rem;
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }
    nav a:hover { text-decoration: underline; }
    .no-access {
      text-align: center;
      padding: 3rem 1rem;
      color: #555;
    }
    #create-buttons button {
      margin-right: 0.5rem;
      margin-bottom: 0.5rem;
    }
  </style>

  <!-- jsPDF dla PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.3/jspdf.plugin.autotable.min.js"></script>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-auth.js";
    import { getFirestore, collection, addDoc, getDocs, doc, getDoc, runTransaction, Timestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyACzVKOmFK87VJJvBGCW921yrxbpKgYEKU",
      authDomain: "iiitla-zadania.firebaseapp.com",
      projectId: "iiitla-zadania",
      storageBucket: "iiitla-zadania.firebasestorage.app",
      messagingSenderId: "753248383455",
      appId: "1:753248383455:web:f39ab717514c979913146a",
      measurementId: "G-9DQCJ8T5QQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const ADMINS = [
      "mbecela@3tla.local",
      "nnoczynska@3tla.local"
    ];

    // ──── Helpers ────────────────────────────────────────
    const $ = id => document.getElementById(id);
    const show = el => el?.classList.remove("hidden");
    const hide = el => el?.classList.add("hidden");

    let currentUserEmail = '';
    let currentDocType = '';
    let counterCache = {}; // Cache dla numerów bieżących

    // ──── Ładowanie listy dokumentów ─────────────────────
    async function loadDocuments() {
      const container = $("documents-list");
      container.innerHTML = "<p>Ładowanie dokumentów...</p>";

      try {
        const q = query(collection(db, "documents"), orderBy("createdAt", "desc"));
        const querySnapshot = await getDocs(q);

        container.innerHTML = "";

        if (querySnapshot.empty) {
          container.innerHTML = "<p>Nie ma jeszcze żadnych dokumentów.</p>";
          return;
        }

        querySnapshot.forEach(docSnap => {
          const data = docSnap.data();
          const date = data.createdAt.toDate().toLocaleString("pl-PL");
          const div = document.createElement("div");
          div.className = "document-item";
          div.innerHTML = `
            <span><strong>${data.type} nr ${data.number}</strong> (${data.createdBy}, ${date})</span>
          `;
          const downloadBtn = document.createElement("button");
          downloadBtn.textContent = "Pobierz PDF";
          downloadBtn.onclick = () => generatePDFFromData(data);
          div.appendChild(downloadBtn);
          container.appendChild(div);
        });
      } catch (err) {
        container.innerHTML = `<p class="error">Nie udało się wczytać dokumentów: ${err.message}</p>`;
      }
    }

    // ──── Generowanie PDF z danych dokumentu ─────────────
    function generatePDFFromData(data) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const type = data.type;

      let y = 10;

      // Nagłówek wspólny
      doc.setFontSize(22);
      doc.setFont("helvetica", "bold");
      doc.text(type === "Faktura" ? "FAKTURA SPRZEDAŻY" : "3TLA", 105, y, { align: "center" });
      y += 15;

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");

      // Specyficzne pola w zależności od typu
      if (type === "PZ" || type === "WZ") {
        doc.text(`Kontrahent: ${data.kontrahent.nazwa || ''}, ${data.kontrahent.adres || ''}, NIP: ${data.kontrahent.nip || ''}, REGON: ${data.kontrahent.regon || ''}`, 10, y);
        y += 10;
        doc.text(`Numer: ${data.number}`, 10, y);
        y += 10;
        doc.text(`Data: ${data.date}`, 10, y);
        y += 10;
        doc.text(`Przeznaczenie: ${data.przeznaczenie || ''}`, 10, y);
        y += 15;
      } else if (type === "MM" || type === "RW" || type === "PW") {
        doc.text(`Skąd: ${data.skad || ''}`, 10, y);
        y += 10;
        doc.text(`Dokąd: ${data.dokad || ''}`, 10, y);
        y += 10;
        doc.text(`Numer: ${data.number}`, 10, y);
        y += 10;
        doc.text(`Data: ${data.date}`, 10, y);
        y += 10;
        doc.text(`Przeznaczenie: ${data.przeznaczenie || ''}`, 10, y);
        y += 15;
      } else if (type === "Faktura") {
        doc.text(`Numer faktury: ${data.number}`, 10, y);
        y += 10;
        doc.text(`Miejscowość: ${data.miejscowosc || ''}, Data sprzedaży: ${data.dataSprzedazy || ''}, Data wystawienia: ${data.dataWystawienia || ''}`, 10, y);
        y += 10;
        doc.text(`Sprzedawca: 3TLa`, 10, y);
        y += 10;
        doc.text(`Nabywca: ${data.nabywca.firma || ''}, ${data.nabywca.adres || ''}, NIP: ${data.nabywca.nip || ''}`, 10, y);
        y += 15;
      }

      // Tabela
      const tableColumns = type === "Faktura" 
        ? ["Lp.", "Nazwa wyrobu", "Ilość", "J.m.", "Cena netto", "Wartość netto", "VAT %", "Kwota VAT", "Wartość brutto"]
        : ["KTM", "Nazwa wyrobu", "Ilość", "J.m.", "Cena jednostkowa", "Wartość"];

      const tableRows = data.items.map((item, index) => {
        if (type === "Faktura") {
          return [
            index + 1,
            item.nazwa,
            item.ilosc,
            item.jm,
            item.cenaNetto,
            item.wartoscNetto,
            item.vat,
            item.kwotaVat,
            item.wartoscBrutto
          ];
        } else {
          return [
            item.ktm,
            item.nazwa,
            item.ilosc,
            item.jm,
            item.cena,
            item.wartosc
          ];
        }
      });

      doc.autoTable({
        startY: y,
        head: [tableColumns],
        body: tableRows,
        theme: 'grid',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [66, 139, 202] }
      });

      y = doc.lastAutoTable.finalY + 15;

      if (type === "Faktura") {
        doc.text(`Razem netto: ${data.summary.netto || ''}, VAT: ${data.summary.vat || ''}, Brutto: ${data.summary.brutto || ''}`, 10, y);
        y += 10;
        doc.text(`Sposób zapłaty: ${data.zaplata.sposob || ''}, Termin: ${data.zaplata.termin || ''}, Konto: ${data.zaplata.konto || ''}`, 10, y);
        y += 10;
        doc.text(`Do zapłaty słownie: ${data.zaplata.slownie || ''}`, 10, y);
        y += 15;
      }

      // Podpis
      doc.setFont("helvetica", "bold");
      doc.text(`Podpis: ${data.createdBy}`, 150, y, { align: "right" });

      doc.save(`${type}_${data.number}.pdf`);
    }

    // ──── Pobieranie numeru bieżącego ────────────────────
    async function getNextNumber(type) {
      if (counterCache[type]) return counterCache[type] + 1;

      const counterRef = doc(db, "counters", type);
      return await runTransaction(db, async (transaction) => {
        const counterSnap = await transaction.get(counterRef);
        const current = counterSnap.exists() ? counterSnap.data().value : 0;
        const next = current + 1;
        transaction.set(counterRef, { value: next });
        counterCache[type] = next;
        return next;
      });
    }

    // ──── Tworzenie nowego dokumentu ─────────────────────
    function showForm(type) {
      currentDocType = type;
      show($("form-section"));
      $("form-title").textContent = `Tworzenie dokumentu: ${type}`;
      const table = $("items-table");
      table.innerHTML = '';

      // Nagłówki tabeli w zależności od typu
      let headers = [];
      if (type === "Faktura") {
        headers = ["Lp.", "Nazwa wyrobu", "Ilość", "J.m.", "Cena netto", "Wartość netto", "VAT %", "Kwota VAT", "Wartość brutto"];
      } else {
        headers = ["KTM", "Nazwa wyrobu", "Ilość", "J.m.", "Cena jednostkowa", "Wartość"];
      }

      const thead = document.createElement("thead");
      const tr = document.createElement("tr");
      headers.forEach(h => {
        const th = document.createElement("th");
        th.textContent = h;
        tr.appendChild(th);
      });
      const thAction = document.createElement("th");
      thAction.textContent = "Akcje";
      tr.appendChild(thAction);
      thead.appendChild(tr);
      table.appendChild(thead);

      const tbody = document.createElement("tbody");
      table.appendChild(tbody);

      addRow(type);

      // Pokaz pola specyficzne dla typu
      hide($("pz-wz-fields"));
      hide($("mm-rw-pw-fields"));
      hide($("faktura-fields"));

      if (type === "PZ" || type === "WZ") {
        show($("pz-wz-fields"));
      } else if (type === "MM" || type === "RW" || type === "PW") {
        show($("mm-rw-pw-fields"));
      } else if (type === "Faktura") {
        show($("faktura-fields"));
      }
    }

    // ──── Dodawanie wiersza do tabeli ────────────────────
    function addRow(type) {
      const tbody = $("items-table").querySelector("tbody");
      const row = document.createElement("tr");

      if (type === "Faktura") {
        const lp = tbody.children.length + 1;
        row.innerHTML = `
          <td>${lp}</td>
          <td><input type="text" class="nazwa" placeholder="Nazwa wyrobu"></td>
          <td><input type="number" class="ilosc" min="1" value="1"></td>
          <td><input type="text" class="jm" placeholder="J.m."></td>
          <td><input type="number" class="cena-netto" min="0" step="0.01"></td>
          <td><input type="number" class="wartosc-netto" readonly></td>
          <td>
            <select class="vat">
              <option value="23">23%</option>
              <option value="8">8%</option>
              <option value="5">5%</option>
              <option value="0">0%</option>
            </select>
          </td>
          <td><input type="number" class="kwota-vat" readonly></td>
          <td><input type="number" class="wartosc-brutto" readonly></td>
        `;
      } else {
        row.innerHTML = `
          <td><input type="text" class="ktm" placeholder="KTM"></td>
          <td><input type="text" class="nazwa" placeholder="Nazwa wyrobu"></td>
          <td><input type="number" class="ilosc" min="1" value="1"></td>
          <td><input type="text" class="jm" placeholder="J.m."></td>
          <td><input type="number" class="cena" min="0" step="0.01"></td>
          <td><input type="number" class="wartosc" readonly></td>
        `;
      }

      const tdAction = document.createElement("td");
      const btnRemove = document.createElement("button");
      btnRemove.textContent = "Usuń wiersz";
      btnRemove.style.background = "#c00";
      btnRemove.style.width = "auto";
      btnRemove.onclick = () => row.remove();
      tdAction.appendChild(btnRemove);
      row.appendChild(tdAction);

      tbody.appendChild(row);

      // Eventy do obliczania wartości
      row.querySelectorAll('input.ilosc, input.cena-netto, select.vat, input.cena').forEach(input => {
        input.addEventListener("input", () => calculateRow(row, type));
      });
    }

    // ──── Obliczanie wartości w wierszu ──────────────────
    function calculateRow(row, type) {
      if (type === "Faktura") {
        const ilosc = parseFloat(row.querySelector(".ilosc").value) || 0;
        const cenaNetto = parseFloat(row.querySelector(".cena-netto").value) || 0;
        const vat = parseFloat(row.querySelector(".vat").value) / 100;

        const wartoscNetto = ilosc * cenaNetto;
        const kwotaVat = wartoscNetto * vat;
        const wartoscBrutto = wartoscNetto + kwotaVat;

        row.querySelector(".wartosc-netto").value = wartoscNetto.toFixed(2);
        row.querySelector(".kwota-vat").value = kwotaVat.toFixed(2);
        row.querySelector(".wartosc-brutto").value = wartoscBrutto.toFixed(2);
      } else {
        const ilosc = parseFloat(row.querySelector(".ilosc").value) || 0;
        const cena = parseFloat(row.querySelector(".cena").value) || 0;
        const wartosc = ilosc * cena;
        row.querySelector(".wartosc").value = wartosc.toFixed(2);
      }
    }

    // ──── Zapisywanie dokumentu ──────────────────────────
    async function saveDocument() {
      const errorEl = $("save-error");
      errorEl.textContent = "";

      const type = currentDocType;
      const number = await getNextNumber(type);
      const date = new Date().toLocaleString("pl-PL");
      const items = [];

      $("items-table").querySelectorAll("tbody tr").forEach(row => {
        const item = {};
        if (type === "Faktura") {
          item.nazwa = row.querySelector(".nazwa").value;
          item.ilosc = row.querySelector(".ilosc").value;
          item.jm = row.querySelector(".jm").value;
          item.cenaNetto = row.querySelector(".cena-netto").value;
          item.wartoscNetto = row.querySelector(".wartosc-netto").value;
          item.vat = row.querySelector(".vat").value;
          item.kwotaVat = row.querySelector(".kwota-vat").value;
          item.wartoscBrutto = row.querySelector(".wartosc-brutto").value;
        } else {
          item.ktm = row.querySelector(".ktm").value;
          item.nazwa = row.querySelector(".nazwa").value;
          item.ilosc = row.querySelector(".ilosc").value;
          item.jm = row.querySelector(".jm").value;
          item.cena = row.querySelector(".cena").value;
          item.wartosc = row.querySelector(".wartosc").value;
        }
        items.push(item);
      });

      if (items.length === 0) {
        errorEl.textContent = "Dodaj co najmniej jeden wiersz do tabeli";
        return;
      }

      const data = {
        type,
        number,
        date,
        createdBy: currentUserEmail,
        createdAt: Timestamp.now(),
        items
      };

      // Dodaj pola specyficzne
      if (type === "PZ" || type === "WZ") {
        data.kontrahent = {
          nazwa: $("kontrahent-nazwa").value,
          adres: $("kontrahent-adres").value,
          nip: $("kontrahent-nip").value,
          regon: $("kontrahent-regon").value
        };
        data.przeznaczenie = $("przeznaczenie").value;
      } else if (type === "MM" || type === "RW" || type === "PW") {
        data.skad = $("skad").value;
        data.dokad = $("dokad").value;
        data.przeznaczenie = $("przeznaczenie").value;
      } else if (type === "Faktura") {
        data.miejscowosc = $("miejscowosc").value;
        data.dataSprzedazy = $("data-sprzedazy").value;
        data.dataWystawienia = $("data-wystawienia").value;
        data.nabywca = {
          firma: $("nabywca-firma").value,
          adres: $("nabywca-adres").value,
          nip: $("nabywca-nip").value
        };
        data.summary = {
          netto: Array.from($("items-table").querySelectorAll(".wartosc-netto")).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2),
          vat: Array.from($("items-table").querySelectorAll(".kwota-vat")).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2),
          brutto: Array.from($("items-table").querySelectorAll(".wartosc-brutto")).reduce((sum, el) => sum + parseFloat(el.value || 0), 0).toFixed(2)
        };
        data.zaplata = {
          sposob: $("sposob-zaplaty").value,
          termin: $("termin-zaplaty").value,
          konto: $("numer-konta").value,
          slownie: $("slownie").value
        };
      }

      try {
        await addDoc(collection(db, "documents"), data);
        alert("Dokument zapisany i wygenerowany!");
        generatePDFFromData(data); // Automatyczne pobranie PDF
        hide($("form-section"));
        loadDocuments();
      } catch (err) {
        errorEl.textContent = "Błąd zapisu: " + err.message;
      }
    }

    // ──── Nasłuch stanu ──────────────────────────────────
    onAuthStateChanged(auth, user => {
      if (!user) {
        window.location.href = "index.html";
        return;
      }

      hide($("loading"));
      show($("content"));
      currentUserEmail = user.email;
      $("current-user").textContent = user.email;
      loadDocuments();
    });

    // ──── Eventy ─────────────────────────────────────────
    document.addEventListener("DOMContentLoaded", () => {
      $("btn-logout")?.addEventListener("click", () => signOut(auth));
      $("btn-save-doc")?.addEventListener("click", saveDocument);
      $("btn-add-row")?.addEventListener("click", () => addRow(currentDocType));

      // Przyciski tworzenia
      $("btn-pz")?.addEventListener("click", () => showForm("PZ"));
      $("btn-wz")?.addEventListener("click", () => showForm("WZ"));
      $("btn-mm")?.addEventListener("click", () => showForm("MM"));
      $("btn-rw")?.addEventListener("click", () => showForm("RW"));
      $("btn-pw")?.addEventListener("click", () => showForm("PW"));
      $("btn-faktura")?.addEventListener("click", () => showForm("Faktura"));
    });
  </script>
</head>
<body>

  <div id="loading">
    <h2>Ładowanie...</h2>
  </div>

  <div id="content" class="hidden">
    <nav>
      <a href="index.html">← Strona główna / Zadania</a>
      <a href="oceny.html">Oceny (admin)</a>
      <a href="magazyn.html">Magazyn</a>
      <a href="produkcja.html">Produkcja</a>
    </nav>

    <h1>Panel Dokumentów</h1>
    <p>Zalogowany jako: <strong id="current-user"></strong></p>
    <button id="btn-logout" class="logout">Wyloguj się</button>

    <div id="create-buttons">
      <h2>Utwórz nowy dokument</h2>
      <button id="btn-pz">Utwórz PZ</button>
      <button id="btn-wz">Utwórz WZ</button>
      <button id="btn-mm">Utwórz MM</button>
      <button id="btn-rw">Utwórz RW</button>
      <button id="btn-pw">Utwórz PW</button>
      <button id="btn-faktura">Utwórz Fakturę</button>
    </div>

    <div id="form-section" class="hidden">
      <h2 id="form-title">Tworzenie dokumentu</h2>

      <!-- Pola dla PZ/WZ -->
      <div id="pz-wz-fields" class="hidden">
        <h3>Dane kontrahenta</h3>
        <input id="kontrahent-nazwa" placeholder="Nazwa kontrahenta">
        <input id="kontrahent-adres" placeholder="Adres">
        <input id="kontrahent-nip" placeholder="NIP">
        <input id="kontrahent-regon" placeholder="REGON">
        <input id="przeznaczenie" placeholder="Przeznaczenie">
      </div>

      <!-- Pola dla MM/RW/PW -->
      <div id="mm-rw-pw-fields" class="hidden">
        <input id="skad" placeholder="Skąd">
        <input id="dokad" placeholder="Dokąd">
        <input id="przeznaczenie" placeholder="Przeznaczenie">
      </div>

      <!-- Pola dla Faktury -->
      <div id="faktura-fields" class="hidden">
        <input id="miejscowosc" placeholder="Miejscowość">
        <input id="data-sprzedazy" type="date" placeholder="Data sprzedaży">
        <input id="data-wystawienia" type="date" placeholder="Data wystawienia">
        <h3>Nabywca</h3>
        <input id="nabywca-firma" placeholder="Firma nabywcy">
        <input id="nabywca-adres" placeholder="Adres">
        <input id="nabywca-nip" placeholder="NIP">
        <h3>Zapłata</h3>
        <input id="sposob-zaplaty" placeholder="Sposób zapłaty">
        <input id="termin-zaplaty" type="date" placeholder="Termin zapłaty">
        <input id="numer-konta" placeholder="Numer konta">
        <input id="slownie" placeholder="Do zapłaty słownie">
      </div>

      <h3>Tabela pozycji</h3>
      <table id="items-table"></table>
      <button id="btn-add-row">Dodaj wiersz</button>

      <button id="btn-save-doc">Zapisz i pobierz PDF</button>
      <div id="save-error" class="error"></div>
    </div>

    <h2>Lista utworzonych dokumentów</h2>
    <div id="documents-list"></div>
  </div>

</body>
</html>
