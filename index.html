<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<title>Panel Zada≈Ñ</title>
<style>
body {
  font-family: Arial, sans-serif;
  max-width: 800px;
  margin: auto;
}
.hidden { display: none; }
textarea {
  width: 100%;
  height: 140px;
}
.task {
  border: 1px solid #ccc;
  padding: 10px;
  margin: 10px 0;
}
</style>
</head>
<body>

<h1>Panel Zada≈Ñ</h1>

<!-- LOGOWANIE -->
<div id="loginBox">
  <input id="email" placeholder="email">
  <input id="password" type="password" placeholder="has≈Ço">
  <button onclick="login()">Zaloguj</button>
</div>

<!-- PANEL -->
<div id="panel" class="hidden">
  Zalogowano jako: <b id="who"></b>
  <button onclick="logout()">Wyloguj</button>

  <hr>

  <h3>Wy≈õlij zadanie (TYLKO mbecela)</h3>
  <input id="to" placeholder="login odbiorcy">
  <br><br>
  <textarea id="text" maxlength="2000"></textarea>
  <br>
  <button onclick="sendTask()">Wy≈õlij</button>

  <hr>

  <h3>Twoje zadania</h3>
  <div id="tasks"></div>
</div>

<script type="module">
/* ================= FIREBASE ================= */

import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  signInWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  query,
  where,
  orderBy,
  onSnapshot,
  serverTimestamp
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* üî¥ TU WKLEJ SWOJE DANE */
const firebaseConfig = {
  apiKey: "AIzaSyACzVKOmFK87VJJvBGCW921yrxbpKgYEKU",
  authDomain: "iiitla-zadania.firebaseapp.com",
  projectId: "iiitla-zadania",
  storageBucket: "iiitla-zadania.firebasestorage.app",
  messagingSenderId: "753248383455",
  appId: "1:753248383455:web:f39ab717514c979913146a",
  measurementId: "G-9DQCJ8T5QQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

/* ================= NORMALIZACJA LOGINU ================= */

/*function normalizeLogin(str) {
  return str
    .normalize("NFKD")                 // rozbij znaki unicode
    .replace(/≈Ç/g, "l")
    .replace(/≈Å/g, "l")
    .replace(/≈Ñ/g, "n")
    .replace(/≈É/g, "n")
    .replace(/[\u0300-\u036f]/g, "")   // usu≈Ñ znaki ≈ÇƒÖczƒÖce
    .toLowerCase()
    .trim();
} */

/* ================= LOGOWANIE ================= */

window.login = async () => {
  try {
    await signInWithEmailAndPassword(
      auth,
      email.value.trim(),
      password.value
    );
  } catch (e) {
    alert("B≈ÇƒÖd logowania: " + e.message);
    console.error(e);
  }
};

window.logout = async () => {
  await signOut(auth);
};

onAuthStateChanged(auth, user => {
  if (!user) {
    loginBox.classList.remove("hidden");
    panel.classList.add("hidden");
    return;
  }

  const rawLogin = user.email.split("@")[0];
  const login = normalizeLogin(rawLogin);

  who.textContent = rawLogin;

  loginBox.classList.add("hidden");
  panel.classList.remove("hidden");

  loadTasks(login);
});

/* ================= ZADANIA ================= */

function loadTasks(login) {
  const q = query(
    collection(db, "tasks"),
    where("to", "==", login),
    orderBy("created", "desc")
  );

  onSnapshot(q, snap => {
    tasks.innerHTML = "";
    let i = 1;

    snap.forEach(doc => {
      const t = doc.data();
      tasks.innerHTML += `
        <div class="task">
          <b>#${i++}</b><br>
          Od: ${t.from}<br><br>
          ${t.text}
        </div>
      `;
    });
  });
}

window.sendTask = async () => {
  const user = auth.currentUser;
  const sender = normalizeLogin(user.email.split("@")[0]);

  if (sender !== "mbecela") {
    alert("Tylko mbecela mo≈ºe wysy≈Çaƒá zadania");
    return;
  }

  const target = normalizeLogin(to.value);

  await addDoc(collection(db, "tasks"), {
    from: "mbecela",
    to: target,
    text: text.value,
    created: serverTimestamp()
  });

  text.value = "";
};
</script>

</body>
</html>
