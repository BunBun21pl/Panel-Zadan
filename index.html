<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Zadaniowy</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .hidden { display: none; }
        textarea { width: 100%; height: 200px; }
        #task-list { margin-top: 20px; }
        .task { border: 1px solid #ccc; padding: 10px; margin-bottom: 10px; }
        .bold { font-weight: bold; }
    </style>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js"></script>
</head>
<body>
    <h1>System Zadaniowy</h1>

    <!-- Sekcja logowania -->
    <div id="login-section">
        <h2>Logowanie</h2>
        <input type="email" id="email" placeholder="Email (@3tla.local)" required>
        <input type="password" id="password" placeholder="Hasło" required>
        <button onclick="login()">Zaloguj się</button>
        <p id="login-error" style="color: red;"></p>
    </div>

    <!-- Sekcja użytkownika po zalogowaniu -->
    <div id="user-section" class="hidden">
        <p>Zalogowany jako: <span id="user-email"></span></p>
        <button onclick="logout()">Wyloguj się</button>
        <div id="task-list">
            <h2>Twoje zadania</h2>
            <!-- Zadania będą tu dynamicznie dodawane -->
        </div>
    </div>

    <!-- Sekcja admina -->
    <div id="admin-section" class="hidden">
        <h2>Panel Admina: Wysyłanie zadań</h2>
        <input type="email" id="target-email" placeholder="Email odbiorcy (@3tla.local)" required>
        <textarea id="task-message" placeholder="Wpisz zadanie (do 5000 znaków). Użyj **tekst** do pogrubienia." maxlength="5000"></textarea>
        <button onclick="sendTask()">Wyślij zadanie</button>
        <p id="send-error" style="color: red;"></p>
    </div>

    <script>
        // Konfiguracja Firebase - ZASTĄP TYM SWOJĄ KONFIGURACJĄ Z KONSOI FIREBASE!
        const firebaseConfig = {
            apiKey: "AIzaSyACzVKOmFK87VJJvBGCW921yrxbpKgYEKU",
            authDomain: "iiitla-zadania.firebaseapp.com",
            projectId: "iiitla-zadania",
            storageBucket: "iiitla-zadania.firebasestorage.app",
            messagingSenderId: "753248383455",
            appId: "1:753248383455:web:f39ab717514c979913146a",
            measurementId: "G-9DQCJ8T5QQ"
        };

        // Inicjalizacja Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const ADMIN_EMAIL = 'mbecela@3tla.local';

        // Funkcja logowania
        function login() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const error = document.getElementById('login-error');

            if (!email.endsWith('@3tla.local')) {
                error.textContent = 'Email musi kończyć się na @3tla.local';
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    document.getElementById('login-section').classList.add('hidden');
                    document.getElementById('user-section').classList.remove('hidden');
                    document.getElementById('user-email').textContent = email;
                    loadTasks(email);

                    if (email === ADMIN_EMAIL) {
                        document.getElementById('admin-section').classList.remove('hidden');
                    }
                })
                .catch(err => {
                    error.textContent = 'Błąd logowania: ' + err.message;
                });
        }

        // Funkcja wylogowania
        function logout() {
            auth.signOut().then(() => {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('user-section').classList.add('hidden');
                document.getElementById('admin-section').classList.add('hidden');
                document.getElementById('task-list').innerHTML = '<h2>Twoje zadania</h2>';
            });
        }

        // Ładowanie zadań dla użytkownika
        function loadTasks(email) {
            const taskList = document.getElementById('task-list');
            taskList.innerHTML = '<h2>Twoje zadania</h2>'; // Reset

            db.collection('tasks').doc(email).get()
                .then(doc => {
                    if (doc.exists) {
                        const tasks = doc.data().tasks || [];
                        tasks.forEach(task => {
                            const taskDiv = document.createElement('div');
                            taskDiv.classList.add('task');
                            // Proste renderowanie Markdown dla bold: **tekst** -> <span class="bold">tekst</span>
                            const renderedTask = task.replace(/\*\*(.*?)\*\*/g, '<span class="bold">$1</span>');
                            taskDiv.innerHTML = renderedTask;
                            taskList.appendChild(taskDiv);
                        });
                    } else {
                        taskList.innerHTML += '<p>Brak zadań.</p>';
                    }
                })
                .catch(err => {
                    console.error('Błąd ładowania zadań:', err);
                });
        }

        // Wysyłanie zadania przez admina
        function sendTask() {
            const targetEmail = document.getElementById('target-email').value;
            const message = document.getElementById('task-message').value;
            const error = document.getElementById('send-error');

            if (!targetEmail.endsWith('@3tla.local')) {
                error.textContent = 'Email odbiorcy musi kończyć się na @3tla.local';
                return;
            }

            if (message.length > 5000) {
                error.textContent = 'Wiadomość przekracza 5000 znaków';
                return;
            }

            // Pobierz istniejące zadania lub utwórz nowe
            const userTasksRef = db.collection('tasks').doc(targetEmail);
            userTasksRef.get()
                .then(doc => {
                    let tasks = [];
                    if (doc.exists) {
                        tasks = doc.data().tasks || [];
                    }
                    tasks.push(message); // Dodaj nowe zadanie

                    userTasksRef.set({ tasks: tasks })
                        .then(() => {
                            error.textContent = '';
                            alert('Zadanie wysłane!');
                            document.getElementById('task-message').value = '';
                        })
                        .catch(err => {
                            error.textContent = 'Błąd wysyłania: ' + err.message;
                        });
                });
        }

        // Obserwuj stan autentykacji
        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('user-section').classList.remove('hidden');
                document.getElementById('user-email').textContent = user.email;
                loadTasks(user.email);

                if (user.email === ADMIN_EMAIL) {
                    document.getElementById('admin-section').classList.remove('hidden');
                }
            } else {
                document.getElementById('login-section').classList.remove('hidden');
                document.getElementById('user-section').classList.add('hidden');
                document.getElementById('admin-section').classList.add('hidden');
            }
        });
    </script>
</body>
</html>
